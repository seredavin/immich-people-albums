name: Verify Docker Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to verify (e.g., latest, v1.0.0)'
        required: true
        default: 'latest'
        type: string

jobs:
  verify:
    name: Verify Docker image in registry
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify image exists and works
      run: |
        IMAGE="ghcr.io/${{ github.repository_owner }}/immich-people-albums:${{ inputs.image_tag }}"
        echo "Verifying image: $IMAGE"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ API
        echo "üìã Checking image metadata..."
        curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://ghcr.io/v2/${{ github.repository_owner }}/immich-people-albums/manifests/${{ inputs.image_tag }}" \
          -o /dev/null -w "HTTP Status: %{http_code}\n"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑
        echo "üì• Pulling image..."
        docker pull $IMAGE
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Python (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º entrypoint –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
        echo "üêç Checking Python version..."
        docker run --rm --entrypoint python $IMAGE --version
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        echo "üì¶ Checking dependencies..."
        docker run --rm --entrypoint python $IMAGE -c "import requests; import yaml; print('‚úÖ All dependencies OK')"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞
        echo "üìä Image size:"
        docker images $IMAGE --format "{{.Size}}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ main.py –¥–æ—Å—Ç—É–ø–µ–Ω
        echo "üìÑ Checking main.py..."
        docker run --rm --entrypoint test $IMAGE -f /app/main.py && echo "‚úÖ main.py found"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ entrypoint —Å–∫—Ä–∏–ø—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
        docker run --rm --entrypoint test $IMAGE -f /docker-entrypoint.sh && echo "‚úÖ entrypoint script found" || echo "‚ÑπÔ∏è  No entrypoint script (using default CMD)"
        
        echo "‚úÖ Image verification completed successfully!"
    
    - name: List all available tags
      run: |
        echo "üìã Available tags in registry:"
        curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://ghcr.io/v2/${{ github.repository_owner }}/immich-people-albums/tags/list" \
          | jq -r '.tags[]' | head -20


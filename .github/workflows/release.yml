name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-push:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/immich-people-albums
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Make package public
      run: |
        # Ð”ÐµÐ»Ð°ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼ Ñ‡ÐµÑ€ÐµÐ· GitHub API
        curl -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/user/packages/container/immich-people-albums" \
          -d '{"visibility":"public"}' || \
        curl -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/immich-people-albums" \
          -d '{"visibility":"public"}'
      continue-on-error: true
    
    - name: Verify image in registry
      run: |
        echo "Verifying image availability..."
        IMAGE="ghcr.io/${{ github.repository_owner }}/immich-people-albums"
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          TAG="${{ github.event.inputs.version }}"
        else
          TAG="${GITHUB_REF#refs/tags/}"
        fi
        
        FULL_IMAGE="$IMAGE:$TAG"
        echo "Checking image: $FULL_IMAGE"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· API
        echo "ðŸ“‹ Checking image metadata via API..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://ghcr.io/v2/${{ github.repository_owner }}/immich-people-albums/manifests/$TAG")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Image manifest found (HTTP $HTTP_CODE)"
        else
          echo "âš ï¸  Image manifest check returned HTTP $HTTP_CODE"
        fi
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð· Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾
        echo "ðŸ“¥ Pulling image from registry..."
        if docker pull "$FULL_IMAGE"; then
          echo "âœ… Image successfully pulled from registry"
          echo "ðŸ Testing Python version..."
          docker run --rm --entrypoint python "$FULL_IMAGE" --version
          echo "ðŸ“¦ Testing dependencies..."
          docker run --rm --entrypoint python "$FULL_IMAGE" -c "import requests; import yaml; print('âœ… Dependencies verified')"
          echo "ðŸ“„ Checking main.py..."
          docker run --rm --entrypoint test "$FULL_IMAGE" -f /app/main.py && echo "âœ… main.py found"
          echo "âœ… All verification checks passed!"
        else
          echo "âš ï¸  Could not pull image immediately (may need a moment to propagate)"
        fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-push]
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: Release ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Docker Image
          
          ðŸ“¦ **Image:** `ghcr.io/${{ github.repository_owner }}/immich-people-albums:${{ steps.version.outputs.VERSION }}`
          
          ### Quick Start
          
          ```bash
          # Pull the image
          docker pull ghcr.io/${{ github.repository_owner }}/immich-people-albums:${{ steps.version.outputs.VERSION }}
          
          # Or use the latest tag
          docker pull ghcr.io/${{ github.repository_owner }}/immich-people-albums:latest
          ```
          
          ### Docker Compose
          
          See `docker-compose.public.yml` for an example using the published image.
          
          ---
          
          ${{ github.event.release.body }}

